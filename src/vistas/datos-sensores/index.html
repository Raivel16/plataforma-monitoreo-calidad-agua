<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Principal</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="DatSensor.css" />
    <script src="/socket.io/socket.io.js"></script>

    <style>
      /* Peque√±as reglas para asegurar el dropdown (no tocan tu CSS principal) */
      .user-menu {
        position: relative;
        display: inline-block;
      }
      .user-dropdown {
        position: absolute;
        right: 0;
        top: calc(100% + 8px);
        background: #ffffff;
        border-radius: 6px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
        padding: 8px;
        min-width: 200px;
        z-index: 2000;
        display: none;
      }
      .user-dropdown.active {
        display: block;
      }
      .user-dropdown ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .user-dropdown li {
        margin: 6px 0;
      }
      .user-dropdown button.dropdown-btn {
        width: 100%;
        background: transparent;
        border: none;
        text-align: left;
        padding: 8px;
        cursor: pointer;
        border-radius: 4px;
      }
      .user-dropdown button.dropdown-btn:hover {
        background: rgba(0, 0, 0, 0.04);
      }
      .user-dropdown button.cerrar-sesion {
        background-color: #c0392b;
        color: white;
      }
      .user-dropdown button.cerrar-sesion:hover {
        background-color: #a93226;
      }
    </style>
  </head>

  <body>
    <header class="top-bar">
      <h1>Plataforma de Monitoreo del Agua - Jun√≠n</h1>
      <div class="user-menu">
        <button
          class="user-btn"
          id="userBtn"
          aria-haspopup="true"
          aria-expanded="false"
        >
          <i class="fas fa-user"></i>
          <span class="user-text" id="nombreUsuario"></span>
          <span class="arrow">‚ñº</span>
        </button>
        <div class="user-dropdown" id="userDropdown" role="menu">
          <ul>
            <!-- Aqu√≠ inyectamos los botones seg√∫n el rol -->
          </ul>
        </div>
      </div>
    </header>

    <nav class="main-header">
      <a href="/datos-sensores">DATOS SENSORES</a>
      <a href="#">PREDICCIONES</a>
      <a href="#">VISUALIZACI√ìN</a>
      <a href="#">USUARIOS</a>
      <a href="#">NOTIFICACIONES</a>
      <a href="#" id="logoutLink">SALIR</a>
    </nav>

    <div class="container">
      <aside id="slider" class="slider">
        <div class="slider-option">
          <h2>Opciones</h2>
          <button id="home-btn" class="menu-btn">&#9776;</button>
        </div>
        <ul id="listaOpciones"></ul>
        <div id="acciones"></div>
        <!-- lo dejamos aunque quede vac√≠o -->
      </aside>

      <main id="main-content" class="content">
        <div class="contenedor-datos-sensores">
          <h2>üìä Ingesta de Datos de Sensores</h2>
          <div class="tabla-container">
            <table id="tablaSensores">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ID Sensor</th>
                  <th>ID Par√°metro</th>
                  <th>Tiempo de Registro</th>
                  <th>Tiempo de Env√≠o</th>
                  <th>Valor Original</th>
                  <th>Valor Procesado</th>
                  <th>Valor Normalizado</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="8" class="cargando">Cargando datos...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <script>
      const authApi = "/api/auth";
      const tbody = document.querySelector("#tablaSensores tbody");

      // --- Dropdown elements ---
      const userBtn = document.getElementById("userBtn");
      const userDropdown = document.getElementById("userDropdown");
      const userDropdownList = userDropdown.querySelector("ul");

      userBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isActive = userDropdown.classList.toggle("active");
        userBtn.setAttribute("aria-expanded", isActive ? "true" : "false");
      });

      document.addEventListener("click", (e) => {
        if (!userDropdown.contains(e.target) && !userBtn.contains(e.target)) {
          userDropdown.classList.remove("active");
          userBtn.setAttribute("aria-expanded", "false");
        }
      });

      // --- Lecturas tabla ---
      function agregarNuevaLectura(lectura) {
        const placeholderRow = tbody.querySelector(".cargando");
        if (placeholderRow) placeholderRow.remove();

        const nuevaFilaHTML = `
          <tr>
            <td>${lectura.DatoID ?? "-"}</td>
            <td>${lectura.SensorID ?? "-"}</td>
            <td>${lectura.ParametroID ?? "-"}</td>
            <td>${lectura.TimestampRegistro ?? "-"}</td>
            <td>${lectura.TimestampEnvio ?? "-"}</td>
            <td>${lectura.Valor_original ?? "-"}</td>
            <td>${lectura.Valor_procesado ?? "-"}</td>
            <td>${lectura.Valor_normalizado ?? "-"}</td>
          </tr>
        `;
        tbody.insertAdjacentHTML("afterbegin", nuevaFilaHTML);
      }

      function mostrarRegistrosIniciales(lista) {
        const placeholderRow = tbody.querySelector(".cargando");
        if (placeholderRow) placeholderRow.remove();
        lista.reverse().forEach(agregarNuevaLectura);
      }

      // --- Logout (tu funci√≥n) ---
      async function logout() {
        await fetch(`${authApi}/logout`, {
          method: "POST",
          credentials: "same-origin",
        });
        window.location.reload();
      }

      // --- Mostrar sesi√≥n: inyecta botones en el dropdown (arriba a la derecha) ---
      function mostrarSesion({ UsuarioID, RolID, NombreUsuario }) {
        // nombre en header
        const nombreEl = document.getElementById("nombreUsuario");
        if (nombreEl) nombreEl.textContent = NombreUsuario ?? "Usuario";

        // limpiar men√∫
        userDropdownList.innerHTML = "";

        // helpers para crear items
        const pushBtn = (text, id = "", cls = "") => {
          const li = document.createElement("li");
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = `dropdown-btn ${cls}`.trim();
          if (id) btn.id = id;
          btn.textContent = text;
          li.appendChild(btn);
          userDropdownList.appendChild(li);
          return btn;
        };

        /*// opciones seg√∫n rol
        if (RolID === 1) {
          pushBtn("Panel Administrativo", "btnPanelAdmin");
          pushBtn("Zona de Investigaci√≥n", "btnZonaInvestigacion");
          pushBtn("Zona de Usuarios", "btnZonaUsuarios");
        } else if (RolID === 2) {
          pushBtn("Zona de Investigaci√≥n", "btnZonaInvestigacion");
          pushBtn("Zona de Usuarios", "btnZonaUsuarios");
        } else {
          pushBtn("Zona de Usuarios", "btnZonaUsuarios");
        }*/

        // siempre cerrar sesi√≥n al final (estilado)
        const btnCerrar = pushBtn(
          "Cerrar sesi√≥n",
          "btnCerrarSesion",
          "cerrar-sesion"
        );
        btnCerrar.addEventListener("click", async () => {
          await logout();
        });

        // Opcional: asignar navegaci√≥n a botones (ejemplo)
        const panelAdminBtn = document.getElementById("btnPanelAdmin");
        if (panelAdminBtn)
          panelAdminBtn.addEventListener("click", () => {
            window.location.href = "/admin"; // ajusta la ruta real
          });
        const zonaInvBtn = document.getElementById("btnZonaInvestigacion");
        if (zonaInvBtn)
          zonaInvBtn.addEventListener("click", () => {
            window.location.href = "/investigacion"; // ajusta la ruta real
          });
        const zonaUsuariosBtn = document.getElementById("btnZonaUsuarios");
        if (zonaUsuariosBtn)
          zonaUsuariosBtn.addEventListener("click", () => {
            window.location.href = "/usuarios"; // ajusta la ruta real
          });
      }

      // --- Obtener sesi√≥n ---
      async function getSesion() {
        try {
          const res = await fetch(`${authApi}/session`, {
            credentials: "same-origin",
          });

          if (res.status === 401) return { logeado: false };
          if (!res.ok) return { logeado: false };
          return await res.json();
        } catch (err) {
          console.error("Error al obtener sesi√≥n:", err);
          return { logeado: false };
        }
      }

      // --- Inicializaci√≥n ---
      (async () => {
        // mostrar sesi√≥n (rellena dropdown)
        const sesion = await getSesion();
        if (sesion.logeado) mostrarSesion(sesion);

        // cargar lecturas iniciales
        try {
          const res = await fetch("http://localhost:3000/api/datos/ultimos");
          if (!res.ok) throw new Error("fall√≥");
          const registros = await res.json();
          if (Array.isArray(registros) && registros.length)
            mostrarRegistrosIniciales(registros);
          else {
            const ph = tbody.querySelector(".cargando");
            if (ph) ph.textContent = "No hay datos disponibles.";
          }
        } catch (err) {
          const ph = tbody.querySelector(".cargando");
          if (ph)
            ph.textContent = "No se pueden obtener los datos en este momento.";
          console.error(err);
        }

        // socket
        const socket = io("http://localhost:3000");
        socket.on("nuevaLectura", (lectura) => {
          if (lectura && typeof lectura === "object" && !Array.isArray(lectura))
            agregarNuevaLectura(lectura);
        });
        socket.on("connect_error", () => {
          const ph = tbody.querySelector(".cargando");
          if (ph) ph.textContent = "Error de conexi√≥n con el servidor.";
        });
      })();
    </script>
  </body>
</html>
