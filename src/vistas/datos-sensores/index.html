<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Principal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="DatSensor.css">

  <script src="/socket.io/socket.io.js"></script>

  </head>

<body>

  <header class="top-bar">
    <h1>Plataforma de Monitoreo del Agua - Jun√≠n</h1>
    <div class="user-menu">
      <button class="user-btn" id="userBtn">
        <i class="fas fa-user"></i>
        <span class="user-text" id="nombreUsuario"></span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="user-dropdown" id="userDropdown">
        <ul>
          <li id="changeAccount">Cambiar de cuenta</li>
          <li id="logout">Cerrar sesi√≥n</li>
        </ul>
      </div>
    </div>
  </header>

  <nav class="main-header">
    <a href="./DatSensor/IngesDat.html">DATOS SENSORES</a>
    <a href="#">PREDICCIONES</a>
    <a href="#">VISUALIZACI√ìN</a>
    <a href="#">USUARIOS</a>
    <a href="#">NOTIFICACIONES</a>
    <a href="#" id="logoutLink">SALIR</a>
  </nav>

  <div class="container">
    <aside id="slider" class="slider">
      <div class="slider-option">
        <h2>Opciones</h2>
        <button id="home-btn" class="menu-btn">&#9776;</button>
      </div>
      <ul id="listaOpciones"></ul>
    </aside>

    <main id="main-content" class="content">
      <div class="contenedor-datos-sensores">
        <h2>üìä Ingesta de Datos de Sensores</h2>
        <div class="tabla-container">
          <table id="tablaSensores">
            <thead>
              <tr>
                <th>ID</th>
                <th>ID Sensor</th>
                <th>ID Par√°metro</th>
                <th>Tiempo de Registro</th>
                <th>Tiempo de Env√≠o</th>
                <th>Valor Original</th>
                <th>Valor Procesado</th>
                <th>Valor Normalizado</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" class="cargando">Cargando datos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>


  <script>
   const tbody = document.querySelector("#tablaSensores tbody");
    
    // 'data' almacenar√° un historial de las lecturas, lo cual es buena pr√°ctica
    let data = [] 
    
    // ‚ùå HEMOS ELIMINADO EL BLOQUE 'if (!data.length)'
    // Era redundante, ya que tu HTML ya incluye la fila "Cargando datos...".

    // ‚úÖ FUNCI√ìN CORREGIDA
    // La hemos renombrado para que sea m√°s claro lo que hace:
    // Ya no "carga" datos, sino "a√±ade" una fila.
    function agregarNuevaLectura(lectura) {
      
      // 1. Buscamos la fila "placeholder" (la que dice "Cargando...")
      //    Usamos la clase 'cargando' que ya ten√≠as en tu HTML.
      const placeholderRow = tbody.querySelector(".cargando");
      
      // 2. Si la encontramos, la eliminamos.
      //    Esto solo pasar√° con la *primera* lectura recibida.
      if (placeholderRow) {
        placeholderRow.remove();
      }

      // 3. (Opcional) Guardamos la lectura en nuestro historial
      data.unshift(lectura); // 'unshift' a√±ade al inicio del array

      // 4. Creamos el HTML para la *√∫nica fila nueva*.
      //    Usamos el objeto 'lectura' directamente (¬°sin .map!)
      const nuevaFilaHTML = `
        <tr>
          <td>${lectura.DatoID ?? "-"}</td>
          <td>${lectura.SensorID ?? "-"}</td>
          <td>${lectura.ParametroID ?? "-"}</td>
          <td>${lectura.TimestampRegistro ?? "-"}</td>
          <td>${lectura.TimestampEnvio ?? "-"}</td>
          <td>${lectura.Valor_original ?? "-"}</td>
          <td>${lectura.Valor_procesado ?? "-"}</td>
          <td>${lectura.Valor_normalizado ?? "-"}</td>
        </tr>
      `;

      // 5. Insertamos la nueva fila al *principio* del 'tbody'.
      //    Esto es mucho m√°s eficiente que reemplazar todo el innerHTML.
      tbody.insertAdjacentHTML('afterbegin', nuevaFilaHTML);
    }

    // --- L√≥gica del Socket ---

    const socket = io("http://localhost:3000");

    socket.on("nuevaLectura", (lectura) => {
      console.log("Dato recibido:", lectura);
      
      // ‚úÖ CORRECCI√ìN DE L√ìGICA Y TYPO:
      // Verificamos que la lectura sea un objeto v√°lido
      if (lectura && typeof lectura === 'object' && !Array.isArray(lectura)) {
        
        // Llamamos a nuestra nueva funci√≥n (y corregimos el typo 'ascargarDatosSensores')
        agregarNuevaLectura(lectura);
      
      } else {
        console.error("Dato inv√°lido recibido, se esperaba un objeto:", lectura);
      }
    });

    // (Opcional: Manejar error de conexi√≥n para actualizar el 'placeholder')
    socket.on('connect_error', () => {
       const placeholder = tbody.querySelector(".cargando");
       if (placeholder) {
          placeholder.textContent = "Error de conexi√≥n con el servidor.";
       }
    });
  </script>

</body>

</html>