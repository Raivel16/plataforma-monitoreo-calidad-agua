<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Principal</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="DatSensor.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>

  <body>
    <header class="top-bar">
      <h1>Plataforma de Monitoreo del Agua - Jun铆n</h1>

      <div class="user-menu">
        <button class="user-btn" id="userBtn">
          <i class="fas fa-user"></i>
          <span class="user-text" id="nombreUsuario"></span>
          <i class="arrow fa fa-chevron-down"></i>
        </button>

        <div class="user-dropdown" id="userDropdown">
          <ul>
            <!-- <li id="changeAccount">Cambiar de cuenta</li> -->
            <li id="logout">Cerrar sesi贸n</li>
          </ul>
        </div>
      </div>
    </header>

    <nav class="main-header">
      <a href="/datos-sensores">DATOS SENSORES</a>
      <a href="#">PREDICCIONES</a>
      <a href="/visualizacion">VISUALIZACIN</a>
      <a href="#">USUARIOS</a>
      <a href="#">NOTIFICACIONES</a>
      <a href="#" id="logoutLink">SALIR</a>
    </nav>

    <div class="container">
      <aside id="slider" class="slider">
        <div class="slider-option">
          <h2>Opciones</h2>
          <button id="home-btn" class="menu-btn">&#9776;</button>
        </div>
        <ul id="listaOpciones">
          <li class="active">Datos Sensores</li>
          <!-- <li class="has-submenu">
            Reportes
            <ul class="submenu">
              <li data-href="../Visualizacion/ReporMinsa.html">MINSA</li>
              <li data-href="../Visualizacion/ReporContaminacion.html">
                Riesgo de Contaminaci贸n
              </li>
            </ul>
          </li>
          <li data-href="../Visualizacion/FiltroDat.html" class="filtro">
            Filtro de Datos
          </li> -->
        </ul>
      </aside>
      <button id="toggle-btn" class="toggle-btn">&#9776;</button>

      <main id="main-content" class="content">
        <div class="contenedor-datos-sensores">
          <h2> Ingesta de Datos de Sensores</h2>
          <div class="tabla-container">
            <table id="tablaSensores">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ID Sensor</th>
                  <th>ID Par谩metro</th>
                  <th>Tiempo de Registro</th>
                  <th>Tiempo de Env铆o</th>
                  <th>Valor Original</th>
                  <th>Valor Procesado</th>
                  <th>Valor Normalizado</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="8" class="cargando">Cargando datos...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <script type="module">

      import { logout as logoutFunc, getSesion } from "../util/sesion.js";

      const tbody = document.querySelector("#tablaSensores tbody");

      // --- Lecturas tabla ---
      function agregarNuevaLectura(lectura) {
        const placeholderRow = tbody.querySelector(".cargando");
        if (placeholderRow) placeholderRow.remove();

        const nuevaFilaHTML = `
              <tr>
                <td>${lectura.DatoID ?? "-"}</td>
                <td>${lectura.SensorID ?? "-"}</td>
                <td>${lectura.ParametroID ?? "-"}</td>
                <td>${lectura.TimestampRegistro ?? "-"}</td>
                <td>${lectura.TimestampEnvio ?? "-"}</td>
                <td>${lectura.Valor_original ?? "-"}</td>
                <td>${lectura.Valor_procesado ?? "-"}</td>
                <td>${lectura.Valor_normalizado ?? "-"}</td>
              </tr>
            `;
        tbody.insertAdjacentHTML("afterbegin", nuevaFilaHTML);
      }

      function mostrarRegistrosIniciales(lista) {
        const placeholderRow = tbody.querySelector(".cargando");
        if (placeholderRow) placeholderRow.remove();
        lista.reverse().forEach(agregarNuevaLectura);
      }

      

      //  Control del men煤 desplegable del usuario
      function inicializarMenuUsuario() {
        const userBtn = document.getElementById("userBtn");
        const dropdown = document.getElementById("userDropdown");
        const logout = document.getElementById("logout");
        //const changeAccount = document.getElementById("changeAccount");

        userBtn.addEventListener("click", (e) => {
          e.stopPropagation(); // Evita cierre inmediato
          userBtn.classList.toggle("active");
        });

        logout.addEventListener("click", logoutFunc);

        /*
        changeAccount.addEventListener("click", () => {
          localStorage.removeItem("usuario");
          window.location.href = "../login.html";
        });*/

        document.addEventListener("click", (e) => {
          if (!userBtn.contains(e.target) && !dropdown.contains(e.target)) {
            userBtn.classList.remove("active");
          }
        });
      }


      function inicializarSlider() {
        const slider = document.getElementById("slider");
        const toggleBtn = document.getElementById("toggle-btn");
        const homeBtn = document.getElementById("home-btn");

        //  Ocultar el slider
        homeBtn.addEventListener("click", () => {
          slider.classList.add("hidden");
        });

        //  Mostrar el slider
        toggleBtn.addEventListener("click", () => {
          slider.classList.remove("hidden");
        });

        const listaOpciones = document.getElementById("listaOpciones");

        listaOpciones.addEventListener("click", (e) => {
          const li = e.target.closest("li");
          if (!li) return;

          // Si es un bot贸n con submen煤 (Reportes)
          if (li.classList.contains("has-submenu")) {
            e.preventDefault();
            e.stopPropagation();
            li.classList.toggle("active");
            return;
          }

          // Si tiene destino, redirige normalmente
          if (li.dataset.href) {
            window.location.href = li.dataset.href;
          }
        });
      }

      // --- Inicializaci贸n ---
      (async () => {
        // mostrar sesi贸n (rellena dropdown)
        const sesion = await getSesion();
        if (sesion.logeado) {
          document.getElementById("nombreUsuario").textContent =
            sesion.NombreUsuario;
        }

        inicializarMenuUsuario();
        inicializarSlider();

        // cargar lecturas iniciales
        try {
          const res = await fetch("http://localhost:3000/api/datos/ultimos");
          if (!res.ok) throw new Error("fall贸");
          const registros = await res.json();
          if (Array.isArray(registros) && registros.length)
            mostrarRegistrosIniciales(registros);
          else {
            const ph = tbody.querySelector(".cargando");
            if (ph) ph.textContent = "No hay datos disponibles.";
          }
        } catch (err) {
          const ph = tbody.querySelector(".cargando");
          if (ph)
            ph.textContent = "No se pueden obtener los datos en este momento.";
          console.error(err);
        }

        // socket
        const socket = io("http://localhost:3000");
        socket.on("nuevaLectura", (lectura) => {
          if (lectura && typeof lectura === "object" && !Array.isArray(lectura))
            agregarNuevaLectura(lectura);
        });
        socket.on("connect_error", () => {
          const ph = tbody.querySelector(".cargando");
          if (ph) ph.textContent = "Error de conexi贸n con el servidor.";
        });
      })();
    </script>
  </body>
</html>
